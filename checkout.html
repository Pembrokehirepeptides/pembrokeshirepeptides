<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pembrokeshire Peptides Checkout</title>
<style>
body { font-family: Arial, sans-serif; background:#f4f7f8; margin:0; padding:20px; }
.container { max-width:600px; margin:auto; background:#fff; padding:20px; border-radius:8px; }
h1 { text-align:center; }
table { width:100%; border-collapse: collapse; margin-bottom:20px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#eef3f6; }
input, textarea { width:100%; padding:8px; margin:5px 0; box-sizing:border-box; border-radius:4px; border:1px solid #ccc; }
button.btn { display:inline-block; padding:10px 20px; background:#25D366; color:#fff; text-decoration:none; border-radius:5px; cursor:pointer; border:none; font-weight:bold; margin-top:10px; }
</style>
</head>
<body>
<div class="container">
<h1>Checkout</h1>

<table id="cartTable">
<tr><th>Product</th><th>Qty</th><th>Price (£)</th></tr>
</table>

<p>Total: £<span id="totalPrice">0</span></p>

<h2>Customer Details</h2>
<form id="checkoutForm">
<label>Name:<input type="text" name="name" required></label>
<label>Email (optional):<input type="email" name="email"></label>
<label>Postal Address:<textarea name="address" required></textarea></label>
<button type="submit" class="btn">Send Order via WhatsApp</button>
</form>

<p id="checkoutMessage" style="color:green;margin-top:10px;"></p>
</div>

<script>
const cart = JSON.parse(localStorage.getItem("cart") || "[]");
const cartTable = document.getElementById("cartTable");
const totalPriceEl = document.getElementById("totalPrice");
const checkoutForm = document.getElementById("checkoutForm");
const checkoutMessage = document.getElementById("checkoutMessage");
const WHATSAPP_NUMBER = "447429328012";

let total = 0;
cart.forEach(item => {
    const row = document.createElement("tr");
    const qty = parseInt(item.qty) || 0;
    const price = parseFloat(item.price) || 0;
    const itemTotal = qty * price;
    row.innerHTML = `<td>${item.name}</td><td>${qty}</td><td>£${itemTotal.toFixed(2)}</td>`;
    cartTable.appendChild(row);
    total += itemTotal;
});
totalPriceEl.textContent = total.toFixed(2);

checkoutForm.addEventListener("submit", function(e){
    e.preventDefault();
    if(cart.length === 0){ alert("Cart is empty!"); return; }

    const formData = new FormData(checkoutForm);
    const name = formData.get("name");
    const email = formData.get("email");
    const address = formData.get("address");
    const orderNumber = "PP-" + new Date().getTime();

    let messageText = `*Pembrokeshire Peptides Order*\n`;
    messageText += `---------------------------\n`;
    messageText += `*Order #:* ${orderNumber}\n\n`;
    messageText += `*Products:*\n`;

    let messageTotal = 0;
    cart.forEach(item => {
        const qty = parseInt(item.qty) || 0;
        const price = parseFloat(item.price) || 0;
        const itemTotal = qty * price;
        messageText += `- ${item.name} x${qty} (£${itemTotal.toFixed(2)})\n`;
        messageTotal += itemTotal;
    });

    messageText += `\n*Total:* £${messageTotal.toFixed(2)}\n\n`;
    messageText += `*Customer Details:*\nName: ${name}\nAddress: ${address}\n`;
    if(email) messageText += `Email: ${email}\n`;
    messageText += `---------------------------\n*Research Use Only*`;

    // Encode and open WhatsApp
    const waLink = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(messageText)}`;
    window.open(waLink, "_blank");

    checkoutMessage.textContent = `Your order (#${orderNumber}) is being sent to WhatsApp.`;
    localStorage.removeItem("cart");
});
</script>
</body>
</html>
